<!doctype html><html lang=zh-cn><head><title>The Pytest Discovery - 世界的过客</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The HTML5 Herald"><meta name=author content="Jay Lau"><meta property="og:title" content="The Pytest Discovery"><meta property="og:description" content="对于pytest，我一直是使用，看文档也是只看fixture那部分的。昨天跟公司的vp争论一个问题，vp觉得tests目录下不该有 __init__.py文件，这样子对于unite test来说语义是不对的。要使用setup."><meta property="og:type" content="article"><meta property="og:url" content="https://laujay.com/posts/the-pytest-path/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-05-08T07:38:45+08:00"><meta property="article:modified_time" content="2020-05-08T07:38:45+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="The Pytest Discovery"><meta name=twitter:description content="对于pytest，我一直是使用，看文档也是只看fixture那部分的。昨天跟公司的vp争论一个问题，vp觉得tests目录下不该有 __init__.py文件，这样子对于unite test来说语义是不对的。要使用setup."><meta name=generator content="Hugo 0.83.1"><link rel="shortcut icon" href=https://laujay.com/img/favicon.ico><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://laujay.com/fontawesome/css/all.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda"><link rel=stylesheet type=text/css href=https://laujay.com/css/styles.css></head><body><div id=container><header><h1><a href=https://laujay.com/>世界的过客</a></h1><ul id=social-media><li><a href=https://github.com/lau-jay title=GitHub><i class="fab fa-github fa-lg"></i></a></li></ul><p><em>每个人获得的东西都恰好是他值得获得的东西</em></p></header><nav><ul><li><a href=https://laujay.com/about><i class="fa-li fa fa-lg"></i><span>About</span></a></li><li><a href=https://laujay.com/categories><i class="fa-li fa fa-lg"></i><span>Categories</span></a></li><li><a href=https://laujay.com/tags><i class="fa-li fa fa-lg"></i><span>Tags</span></a></li></ul></nav><main><article><h1>The Pytest Discovery</h1><aside><ul><li><time class=post-date datetime=2020-05-08T07:38:45+08:00>May 8, 2020</time></li><li>Categories:
<em><a href=https://laujay.com/categories/python>python</a></em></li><li><em><a href=https://laujay.com/tags/pytest>#pytest</a></em></li><li>One minute read</li></ul></aside><div class=featured_image><a href=https://laujay.com/posts/the-pytest-path/ title="The Pytest Discovery"><img src></a></div><blockquote><p>对于pytest，我一直是使用，看文档也是只看fixture那部分的。昨天跟公司的vp争论一个问题，vp觉得tests目录下不该有 <code>__init__.py</code>文件，这样子对于unite test来说语义是不对的。要使用<code>setup.py develop</code>将包装载后测试，这样就不会出现我引入<code>__init__.py</code>的初衷，为了找到找不到要测试的包。</p></blockquote><p>首先，我没有认真研究为啥找不到包，但是加了<code>__init__.py</code>在tests目录就能够正常pytest命令跑完测试。也就是说我是不知道原因的情况下，误打误撞利用的pytest的机制。</p><p>为了搞清这个问题我认真阅读了<a href=https://docs.pytest.org/en/latest/goodpractices.html#tests-outside-application-code>该章</a> 发现了如下的文字:</p><blockquote><pre><code>setup.py
mypkg/
   ...
tests/
   __init__.py
   foo/
       __init__.py
       test_view.py
   bar/
       __init__.py
       test_view.py
</code></pre><p>But now this introduces a subtle problem: in order to load the test modules from the <code>tests</code> directory, pytest prepends the root of the repository to <code>sys.path</code>, which adds the side-effect that now <code>mypkg</code> is also importable.This is problematic if you are using a tool like <a href=https://docs.pytest.org/en/latest/goodpractices.html#tox>tox</a> to test your package in a virtual environment, because you want to test the <em>installed</em> version of your package, not the local code from the repository.</p></blockquote><p>解释下，意思是，如果你通过添加<code>__init__.py</code>改变测试目录，使其变为一个测试模块，那么pytest会将根目录添加到sys.path中，使得同级的python包mypkg也可以导入了。但是对于使用tox来多环境测试来说，这是有问题的。</p><p>所以mypkg也能导入这就是我能顺利运行pytest的原因，但是这种情况下，对tox使用不利，虽然公司的代码限定了python版本不需要使用tox。</p><p><a href=https://laike9m.com/>laike9m</a> 说conftest.py文件的机制能达到相同的效果，而且不需要<code>__init__.py</code> 。</p><p>找到文档描述在<a href="https://docs.pytest.org/en/latest/pythonpath.html?highlight=conftest#pytest-import-mechanisms-and-sys-path-pythonpath">这</a></p><p>但是比较奇怪，需要人为加<code>conftest.py</code> 文件在待测试包的同级别目录</p><pre><code>setup.py
mypkg/
    ...
conftest.py
tests/
    foo/
        __init__.py
        test_view1.py
    bar/
        __init__.py
        test_view2.py
</code></pre><p>这样子也行。。</p><p>无论哪种做法都是利用了pytest，而不是将包安装进site-packages</p></article><section class=post-nav><ul><li><a href=https://laujay.com/posts/pyenv-guide-on-osx/><i class="fa fa-chevron-circle-left"></i> Pyenv Guide on OSX</a></li><li><a href=https://laujay.com/posts/the-python-packaging/>The Python Packaging <i class="fa fa-chevron-circle-right"></i></a></li></ul></section><section class=comments-block><button id=show-comments style=display:none><i class="fa fa-comments"></i> Add/View Comments</button></section><section id=disqus_thread></section><script>(function(){var b,e,c,f,g,d;if(window.location.hostname=="localhost")return;if(b=!1,e='lau-jay',c=document.getElementById("show-comments"),f=!0,g=null,g)return;c.style.display="",f?a():c.addEventListener("click",a,!1);function a(){if(!b){b=!0;var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src="//"+e+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a),document.getElementById("show-comments").style.display="none"}}d=window.location.hash.substr(1),d.length>8&&d.substring(0,8)=="comment-"&&a(),/bot|google|baidu|bing|msn|duckduckgo|slurp|yandex/i.test(navigator.userAgent)&&a()})()</script></main><footer><h6>Copyright © 2016 ~ 2021 - Jay Lau|Theme by <a href=https://github.com/funkydan2/hugo-kiera>kiera</a> |
Rendered by <a href=https://gohugo.io title=Hugo>Hugo</a> |
<a href=https://laujay.com/index.xml>Subscribe</a></h6></footer></div><script src=https://laujay.com/js/scripts.js></script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-91611718-2','auto'),ga('send','pageview'))</script></body></html>